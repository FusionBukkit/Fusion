From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: IPECTER <ipectert@gmail.com>
Date: Tue, 1 Nov 2022 13:17:45 +0900
Subject: [PATCH] Lithium-CollectionsEntityFiltering

JettPack - Titaniumtown - GPL 3.0
Lithium - CaffeineMC  - GPL 3.0

diff --git a/src/main/java/com/github/ipecter/fusion/FusionConfig.java b/src/main/java/com/github/ipecter/fusion/FusionConfig.java
index 360534414a8d62ee72fa04be01199cd39dd7189b..1a23a50d90180eebc5de5291807b2d5bd93d3fb5 100644
--- a/src/main/java/com/github/ipecter/fusion/FusionConfig.java
+++ b/src/main/java/com/github/ipecter/fusion/FusionConfig.java
@@ -203,4 +203,5 @@ public class FusionConfig {
     public static boolean lithiumCollectionsAttributes = true;
+    public static boolean lithiumCollectionsEntityFiltering = true;
 
     private static void lithiumConfig() {
         setComment("lithium", "[ Lithium ] General-Purpose Optimization Mod");
@@ -219,3 +220,4 @@ public class FusionConfig {
         lithiumCollectionsAttributes = getBoolean("lithium.collections.attributes", lithiumCollectionsAttributes) && lithiumEnable;
+        lithiumCollectionsEntityFiltering = getBoolean("lithium.collections.entity-filtering", lithiumCollectionsEntityFiltering) && lithiumEnable;
     }
 }
\ No newline at end of file
diff --git a/src/main/java/net/minecraft/util/ClassInstanceMultiMap.java b/src/main/java/net/minecraft/util/ClassInstanceMultiMap.java
index 2707311b46d4645ffe718cfc2e866b4f480544f0..df35b2889a36112ab5a7b267a9905d8c75fe00fc 100644
--- a/src/main/java/net/minecraft/util/ClassInstanceMultiMap.java
+++ b/src/main/java/net/minecraft/util/ClassInstanceMultiMap.java
@@ -55,15 +55,41 @@ public class ClassInstanceMultiMap<T> extends AbstractCollection<T> {
     }
 
     public <S> Collection<S> find(Class<S> type) {
-        if (!this.baseClass.isAssignableFrom(type)) {
-            throw new IllegalArgumentException("Don't know how to search for " + type);
+        // Fusion start - Lithium: Collections Entity Filtering
+        if (com.github.ipecter.fusion.FusionConfig.lithiumCollectionsEntityFiltering) {
+            Collection<T> collection = this.byClass.get(type);
+            if (collection == null) {
+                collection = this.createAllOfType(type);
+            }
+            return (Collection<S>) Collections.unmodifiableCollection(collection);
         } else {
-            List list = this.byClass.computeIfAbsent(type, (typeClass) -> { // Fusion - JettPack: Decomp Fix
-                return this.allInstances.stream().filter(typeClass::isInstance).collect(Collectors.toList());
-            });
-            return Collections.unmodifiableCollection(list);
+            if (!this.baseClass.isAssignableFrom(type)) {
+                throw new IllegalArgumentException("Don't know how to search for " + type);
+            } else {
+                List list = this.byClass.computeIfAbsent(type, (typeClass) -> { // Fusion - JettPack: Decomp Fix
+                    return this.allInstances.stream().filter(typeClass::isInstance).collect(Collectors.toList());
+                });
+                return Collections.unmodifiableCollection(list);
+            }
         }
+        // Fusion end
+    }
+
+    // Fusion start - Lithium: Collections Entity Filtering
+    private <S> Collection<T> createAllOfType(Class<S> type) {
+        List<T> list = new java.util.ArrayList<>();
+
+        for (T allElement : this.allInstances) {
+            if (type.isInstance(allElement)) {
+                list.add(allElement);
+            }
+        }
+
+        this.byClass.put(type, list);
+
+        return list;
     }
+    // Fusion end
 
     @Override
     public Iterator<T> iterator() {
