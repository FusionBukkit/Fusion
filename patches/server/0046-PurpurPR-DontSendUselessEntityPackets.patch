From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: IPECTER <ipectert@gmail.com>
Date: Mon, 14 Nov 2022 16:56:56 +0900
Subject: [PATCH] PurpurPR-DontSendUselessEntityPackets

PurpurMC - Purpur - MIT

diff --git a/src/main/java/com/github/ipecter/fusion/FusionWorldConfig.java b/src/main/java/com/github/ipecter/fusion/FusionWorldConfig.java
index df2695564698ac75e433348c8b6ed6deb3ca01a4..6fb326f066b04abb6aa57a18f24dee0ebfc66e13 100644
--- a/src/main/java/com/github/ipecter/fusion/FusionWorldConfig.java
+++ b/src/main/java/com/github/ipecter/fusion/FusionWorldConfig.java
@@ -170,7 +170,10 @@ public class FusionWorldConfig {
     private void c2meConfigSetup() {
     }
 
+    public boolean packetDontSendUselessEntityPackets = true;
+
     private void packetSettings() {
+        packetDontSendUselessEntityPackets = getBoolean("packet.dont-send-useless-entity-packets", packetDontSendUselessEntityPackets);
     }
 
     private void packetSettingsSetup() {
diff --git a/src/main/java/net/minecraft/server/level/ServerEntity.java b/src/main/java/net/minecraft/server/level/ServerEntity.java
index 7880cdcaf12197f6b36777c51b2859f2463f1595..88765672b90936718d39483da2e762a54eddf1a8 100644
--- a/src/main/java/net/minecraft/server/level/ServerEntity.java
+++ b/src/main/java/net/minecraft/server/level/ServerEntity.java
@@ -182,6 +182,7 @@ public class ServerEntity {
                         this.teleportDelay = 0;
                         packet1 = new ClientboundTeleportEntityPacket(this.entity);
                     }
+                    if (level.fusionConfig.packetDontSendUselessEntityPackets && isUselessPacket(packet1)) packet1 = null; // Fusion - Purpur PR: Dont Send Useless Entity Packets
                 }
 
                 if ((this.trackDelta || this.entity.hasImpulse || this.entity instanceof LivingEntity && ((LivingEntity) this.entity).isFallFlying()) && this.tickCount > 0) {
@@ -248,6 +249,22 @@ public class ServerEntity {
 
     }
 
+    // Fusion start - Purpur PR: Dont Send Useless Entity Packets
+    private boolean isUselessPacket(Packet<?> possibleUselessPacket) {
+        if (possibleUselessPacket instanceof ClientboundMoveEntityPacket) {
+            ClientboundMoveEntityPacket packet = (ClientboundMoveEntityPacket) possibleUselessPacket;
+            if (possibleUselessPacket instanceof ClientboundMoveEntityPacket.Pos) {
+                return packet.getXa() == 0 && packet.getYa() == 0 && packet.getZa() == 0;
+            } else if (possibleUselessPacket instanceof ClientboundMoveEntityPacket.PosRot) {
+                return packet.getXa() == 0 && packet.getYa() == 0 && packet.getZa() == 0 && packet.getyRot() == 0 && packet.getxRot() == 0;
+            } else if (possibleUselessPacket instanceof ClientboundMoveEntityPacket.Rot) {
+                return packet.getyRot() == 0 && packet.getxRot() == 0;
+            }
+        }
+        return false;
+    }
+    // Fusion end
+
     public void removePairing(ServerPlayer player) {
         this.entity.stopSeenByPlayer(player);
         player.connection.send(new ClientboundRemoveEntitiesPacket(new int[]{this.entity.getId()}));
